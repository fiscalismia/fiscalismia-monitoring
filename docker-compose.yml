# =============================================================================
# Fiscalismia Monitoring Stack
# Production-grade Docker Compose for Prometheus & Grafana
# =============================================================================
# Deployment: monitoring.fiscalismia.com @ 172.24.0.2
# =============================================================================

volumes:
  prometheus-data-v:
    name: "prometheus-data-v"
  grafana-data-v:
    name: "grafana-data-v"

services:
  # ===========================================================================
  # Prometheus - Time Series Database & Metrics Collection
  # ===========================================================================
  fiscalismia-prometheus:
    image: ghcr.io/fiscalismia/fiscalismia-monitoring-prometheus:latest
    container_name: fiscalismia-prometheus
    build:
      context: .
      dockerfile: Dockerfile.Prometheus
    restart: unless-stopped
    volumes:
      # Persistent data storage
      - prometheus-data-v:/prometheus/data:z
      # Configuration can be updated without rebuild (optional override)
      # - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro,z
    networks:
      - monitoring-internal
    # No external port exposure - accessed via nginx reverse proxy
    expose:
      - "9090"
    # Container Resource Usage
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: '0.8'
        reservations:
          memory: 512M
          cpus: '0.4'
    ### SECURITY HARDENING
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=128m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    # Health check defined in Dockerfile

  # ===========================================================================
  # Grafana - Visualization & Dashboards
  # ===========================================================================
  fiscalismia-grafana:
    image: ghcr.io/fiscalismia/fiscalismia-monitoring-grafana:latest
    container_name: fiscalismia-grafana
    build:
      context: .
      dockerfile: Dockerfile.Grafana
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Security settings
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SECURITY_SECRET_KEY=${GRAFANA_SECRET_KEY}
      - GF_SECURITY_DISABLE_GRAVATAR=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true
      # Server settings
      - GF_SERVER_ROOT_URL=https://monitoring.fiscalismia.com
      - GF_SERVER_DOMAIN=monitoring.fiscalismia.com
      - GF_SERVER_PROTOCOL=http
      - GF_SERVER_HTTP_PORT=3000
      # Authentication
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      # Users
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      # Logging
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info
      # Paths
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_PATHS_DATA=/var/lib/grafana
    volumes:
      # Persistent data storage
      - grafana-data-v:/var/lib/grafana:z
    networks:
      - monitoring-internal
    # No external port exposure - accessed via nginx reverse proxy
    expose:
      - "3000"
    depends_on:
      fiscalismia-prometheus:
        condition: service_healthy
    # Container Resource Usage
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    ### SECURITY HARDENING
    tmpfs:
      - /tmp:noexec,nosuid,size=128m
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    # Health check defined in Dockerfile

  # ===========================================================================
  # Nginx Reverse Proxy - TLS Termination
  # ===========================================================================
  fiscalismia-monitoring-nginx:
    image: ghcr.io/fiscalismia/fiscalismia-monitoring-nginx:latest
    container_name: fiscalismia-monitoring-nginx
    build:
      context: .
      dockerfile: Dockerfile.Nginx
    restart: unless-stopped
    volumes:
      # TLS certificates mounted at runtime (SELinux relabel with :z)
      - /etc/letsencrypt/live/monitoring.fiscalismia.com/fullchain.pem:/etc/nginx/certs/fullchain.pem:ro,z
      - /etc/letsencrypt/live/monitoring.fiscalismia.com/privkey.pem:/etc/nginx/certs/privkey.pem:ro,z
    networks:
      - monitoring-internal
      - monitoring-external
    ports:
      - "0.0.0.0:443:443/tcp"
    depends_on:
      fiscalismia-prometheus:
        condition: service_healthy
      fiscalismia-grafana:
        condition: service_healthy
    # Container Resource Usage
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 128M
          cpus: '0.1'
    ### SECURITY HARDENING
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=128m
    cap_drop:
      - ALL
    cap_add:
      # Required for binding to port 443
      # Host sysctl: echo "net.ipv4.ip_unprivileged_port_start=80" | sudo tee /etc/sysctl.d/nonroot_can_bind_to_low_ports.conf
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    # Health check defined in Dockerfile

# =============================================================================
# Networks
# =============================================================================
# nftables firewall allows these podman network CIDRs:
# 10.89.0.0/24 | 10.89.1.0/24 | 10.89.2.0/24 | 10.89.3.0/24
# =============================================================================
networks:
  # Internal network for Prometheus <-> Grafana <-> Nginx communication
  monitoring-internal:
    name: monitoring-internal
    driver: bridge
    internal: true  # No external access from this network
    ipam:
      driver: default
      config:
        - subnet: 10.89.2.0/24
          gateway: 10.89.2.1

  # External network for nginx to receive traffic from HAProxy
  monitoring-external:
    name: monitoring-external
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.89.3.0/24
          gateway: 10.89.3.1
